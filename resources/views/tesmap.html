<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet" />

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            height: 50%;
            width: 50%;
        }
    </style>
</head>

<body>
    <button onclick="getNav()">Temukan rute</button>
    <div>
        <p>jarak tempuh: <span id="distance"></span></p>
    </div>
    <div>
        <p>waktu tempuh: <span id="duration"></span></p>
    </div>
    <div id="map"></div>
    <script>

        mapboxgl.accessToken = "{{ config('mapbox.mapbox_token') }}";
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [107.6352581, -6.8960258], // start, bisa diganti dengan koordinate posisi sekarang, [long, lat]
            zoom: 12,
        });

        // const bounds = [[108.6352581, -6.5960258], [107.3352581, -6.9860258]];
        // map.setMaxBounds(bounds);

        // const start = [107.6352581, -6.8960258]; // start, bisa diganti dengan koordinate posisi sekarang, [long, lat]
        const end = [107.6693699, -6.646525]; // LongLat Bunihayu (utara)
        //const end = [107.5005077, -7.0314948]; // LongLat Soreang  (selatan)
        //const end = [107.8667725, -6.85351]; // LongLat  Sumedang (timur)
        //const end = [107.8667725, -6.8222798]; // LongLat Cianjur (barat)
        //const end = [95.3124251, 5.5534109]; // LongLat Masjid Raya Baiturrahman


        function getNav() {
            if ("geolocation" in navigator) {
                // Geolocation is supported by the browser

                navigator.geolocation.getCurrentPosition(
                    // Success callback function
                    (position) => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        const accuracy = position.coords.accuracy; // Accuracy in meters

                        // console.log(`Latitude: ${latitude}`);
                        // console.log(`Longitude: ${longitude}`);
                        // console.log(`Accuracy: ${accuracy} meters`);

                        getRoute([longitude, latitude], end);

                        // You can now use these coordinates, e.g., display them on a map
                        // or send them to a server.
                    },
                    // Error callback function
                    (error) => {
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                console.error("User denied the request for Geolocation.");
                                break;
                            case error.POSITION_UNAVAILABLE:
                                console.error("Location information is unavailable.");
                                break;
                            case error.TIMEOUT:
                                console.error("The request to get user location timed out.");
                                break;
                            case error.UNKNOWN_ERROR:
                                console.error("An unknown error occurred.");
                                break;
                        }
                    },
                    // Optional options object
                    {
                        enableHighAccuracy: true, // Request a more precise location
                        timeout: 5000, // Maximum time (in milliseconds) to wait for a location
                        maximumAge: 0 // Don't use a cached position, get a fresh one
                    }
                );

            } else {
                // Geolocation is not supported by the browser
                console.error("Geolocation is not supported by this browser.");
            }
        }

        async function getRoute(start, end) {

            let api = `https://api.mapbox.com/directions/v5/mapbox/driving/${start[0]},${start[1]};${end[0]},${end[1]}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`;

            const query = await fetch(api);

            const json = await query.json();

            const data = json.routes[0];

            const route = data.geometry;

            const geojson = {
                'type': 'Feature',
                'properties': {},
                'geometry': data.geometry
            };

            if (map.getSource('route')) {
                map.getSource('route').setData(geojson);
            } else {
                map.addLayer({
                    id: 'route',
                    type: 'line',
                    source: {
                        type: 'geojson',
                        data: geojson,
                    },
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round',
                    },
                    paint: {
                        'line-color': 'red',
                        'line-width': 5,
                        'line-opacity': 0.75
                    }
                });
            }

            //const [longM, latM] = haversineFormula(start, end)
            const [longM, latM] = naiveFormula(start, end);
            const distance = Math.floor(data['distance'] / 1000);
            const duration = Math.floor(data["duration"] / 60);
            let zoomLevel = 10; // default;


            if (distance >= 4000) {
                zoomLevel = 3; // you can see earth
            }
            else if (distance >= 2000) {
                zoomLevel = 4; // continent
            }
            else if (distance >= 1000) {
                zoomLevel = 5; // large island
            }
            else if (distance >= 100) {
                zoomLevel = 7;
            }
            else if (distance >= 70) {
                zoomLevel = 8;
            }
            else if (distance >= 40) {
                zoomLevel = 9;
            }
            else if (distance >= 20) {
                zoomLevel = 10;
            }
            else if (distance >= 10) {
                zoomLevel = 11;
            }
            else {
                zoomLevel = 12;
            }

            console.log(zoomLevel);

            map.easeTo({ center: [longM, latM], zoom: zoomLevel, duration: 5000 });

            document.getElementById('distance').innerHTML = `${distance} km`;

            document.getElementById('duration').innerHTML = `${duration} menit`;

        }

        function naiveFormula(start, end) {
            const longM = (start[0] + end[0]) / 2;
            const latM = (start[1] + end[1]) / 2;
            return [longM, latM];
        }

        // function haversineFormula(start, end) {
        //     const alpha = end[0] - start[0];
        //     const bx = Math.cos(end[1]) * Math.cos(alpha);
        //     const by = Math.cos(end[1]) * Math.sin(alpha);

        //     const longM = Math.atan2(by, Math.cos(start[1]) + bx);
        //     const latM = Math.atan2(Math.sin(start[1]) + Math.sin(end[1]), Math.sqrt((Math.cos(start[1]) + bx) * (Math.cos(start[1]) + bx) + (by * by)));

        //     return [longM, latM];
        // }
    </script>
</body>

</html>